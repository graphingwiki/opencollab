#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
    @copyright: 2008 Lari Huttunen
    @license: MIT <http://www.opensource.org/licenses/mit-license.php>
"""

import os
import sys
import string
import optparse
from opencollab.meta import Metas
from opencollab.util.config import parse_config
from opencollab.util.file import hashFile, uploadFile
from opencollab.util.wiki import importMetas

def parse_xml(file, nmaprun_page):
    xml_doc = et.parse(file)

def main():
    parser = optparse.OptionParser()
    parser.add_option( "-c", "--config",
        action="store", type="string", 
        dest="config",
        metavar = "CONFIG",
        help="CONFIG file path.")
    parser.add_option( "-t", "--wiki-template",
        action="store", type="string", 
        dest="template",
        metavar = "TEMPLATE",
        help="Wiki TEMPLATE, e.g. NmapTemplate.")
    parser.add_option( "-u", "--url",
        action="store", type="string", 
        dest="url",
        metavar = "COLLAB-URL",
        help="COLLAB-URL")
    parser.add_option("-v",
        action="store_true", dest="verbose", default=False,
        help="Enable verbose output." )
    parser.add_option( "-w", "--wiki-category",
        action="store", type="string", 
        dest="category",
        metavar = "CATEGORY",
        help="Wiki CATEGORY, e.g. NmapRun.")
    parser.set_usage("%prog [options] NMAP-XML-FILES")
    options, args = parser.parse_args()
    iopts={}
    nmap_files=[]
    metas = Metas()
    if len(args) < 1:
        parser.error("At least one XML input file path needs to be specified.")
    if options.config:
        iopts = parse_config(options.config, "creds", "nmap")
    if options.template:
        directory = options.template
    elif options.config and "template" in iopts["nmap"]:
        template = iopts["nmap"]["template"]
    else:
        template = "NmapTemplate"
    if options.url:
        url = options.url
        collab = CLIWiki(url)
    elif options.config and "url" in iopts["creds"]:
        collab = CLIWiki(url, config=options.config)
    else:
        parser.error("Collab URL needs to be specified.")
    if options.category:
        category = options.category
    elif options.config and "category" in iopts["nmap"]:
        category = iopts["nmap"]["category"]
    else:
        category = None
    if category is not None:
        metas["category"].add(category)
    if options.verbose:
        print "Processing input files."
    for arg in args:
        nmap_files.append(arg)
    for file in nmap_files:
        xml_page = hashFile(file)
        if options.verbose:
            print "Parsing", file
        metas = parse_xml(file, xml_page)
        if options.verbose:
            print "Importing metas to:", url
        importMetas(collab, metas, template)
        if options.verbose:
            print "Uploading", file, "to:", xml_page
        uploadFile(collab, xml_page, file)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "Script interrupted via CTRL-C."

