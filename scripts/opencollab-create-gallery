#! /usr/bin/env python
# -*- coding: utf-8 -*-
"""
    The purpose of this script is to create an object oriented wiki image
    gallery utilizing a file system based image repository as a source.
    The path names are turned into categories, which classify a given
    image.

    @copyright: 2008 Lari Huttunen
    @license: MIT <http://www.opensource.org/licenses/mit-license.php>
"""
import os
import ConfigParser
import Image
from optparse import OptionParser
from opencollab.meta import Meta
from opencollab.wiki import GraphingWiki

def parse_config( cpath ):
    configparser = ConfigParser.ConfigParser()
    configparser.readfp( open(cpath) )
    creds = dict( configparser.items('creds') )
    uris = dict( configparser.items('dbs') )
    username = creds.pop("username")
    password = creds.pop("password")
    spath = uris.pop("spath")
    wiki = uris.pop("collab")
    return username, password, spath, wiki

def store_names( flist, dname, names ): 
    for name in names:
        flist.append( os.path.join( dname, name ) )

def process_image( f, imeta ):
    try:
        img = Image.open( f )
        print f, img.format, "%dx%d" % img.size, img.mode
        return True
    except IOError: 
        return False

def push_image( collab, imeta ):
    pass

def main():
    usage = "usage: %prog [-v] -c CPATH"
    parser = OptionParser(usage=usage)
    parser.add_option( "-c", 
        action="store", type="string", dest="cpath",
        help="Config file path." )
    parser.add_option("-v", 
        action="store_true", dest="verbose", default=False,
        help="Enable verbose output." ) 
    ( options, args ) = parser.parse_args()
    if options.cpath:
        flist = []
        username, password, spath, wiki = parse_config( options.cpath )
        os.path.walk( spath, store_names, flist ) 
        collab = GraphingWiki( wiki, username=username, password=password  )
        for f in flist:
            imeta = Meta()
            image = process_image( f, imeta )
            if image:
                push_image( collab, imeta )
    else:
        parser.error("Option -c is mandatory. Use -h for help.")

if __name__ == "__main__":
    main()

