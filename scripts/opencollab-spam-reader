#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
    @copyright: 2008 Lari Huttunen
    @license: MIT <http://www.opensource.org/licenses/mit-license.php>
"""
import re
import optparse
import getpass
import imaplib
import email
import cStringIO
from email.Iterators import body_line_iterator
from opencollab.util.config import parse_config
from opencollab.util.file import hashFile, uploadFile
from opencollab.util.wiki import importMetas
from opencollab.wiki import CLIWiki
from opencollab.meta import Metas
from opencollab.util.regexp import *
try:
    import email.utils
except:
    import email.Utils

def read_spam(collab, imaps_server, imaps_user, imaps_pass):
    metas = Metas()
    href = re.compile('\w+=\"')
    tag = re.compile('\">?.*$')
    mailbox = imaplib.IMAP4_SSL(imaps_server) 
    if imaps_pass is None:
        mailbox.login(imaps_user,getpass.getpass())
    else:
        mailbox.login(imaps_user,imaps_pass)
    mailbox.select()
    typ, data = mailbox.search(None, 'UNSEEN')
    for num in data[0].split():
        typ, data = mailbox.fetch(num, '(RFC822)')
        msg = email.message_from_string(data[0][1])
        msg_obj = cStringIO.StringIO(data[0][1])
        cpage = hashFile(msg_obj)
        metas[cpage]["RFC822 Message"].add('[[attachment:%s]]' % cpage)
        uploadFile(collab, cpage, data[0][1], cpage)
        body = ""
        for line in body_line_iterator(msg, decode=True):
                body+=line
        tokens = body.split()
        for token in tokens:
            if url_all_re.search(token):
                token = href.sub('', token)
                token = tag.sub('', token)
                metas[cpage]["SPAM URL"].add(token)
    mailbox.close()
    mailbox.logout()
    return metas

def main():
    parser = optparse.OptionParser()
    parser.add_option( "-c", "--config",
        action="store",
        type="string", dest="config",
        metavar="CONFIG",
        help="CONFIG  file path.")
    parser.add_option( "-e", "--imaps-user",
        action="store",
        type="string", dest="imaps_user",
        metavar="IMAPS-USERNAME",
        help="IMAPS-USERNAME.")
    parser.add_option( "-i", "--imaps-server",
        action="store",
        type="string", dest="imaps_server",
        metavar="IMAPS-SERVER",
        help="IMAPS-SERVER name or IP address.")
    parser.add_option( "-t", "--wiki-template",
        action="store",
        type="string", dest="wiki_template",
        metavar="TEMPLATE",
        help="Wiki TEMPLATE.")
    parser.add_option( "-u", "--url",
        action="store",
        type="string", dest="url",
        metavar="COLLAB-URL",
        help="COLLAB-URL to connect to.")
    parser.add_option("-v",
        action="store_true", dest="verbose", default=False,
        help="Enable verbose output." )
    parser.set_usage("%prog [options]")
    options, args = parser.parse_args()
    iopts={}
    if options.config:
        iopts = parse_config(options.config, "creds", "spam")
    if options.imaps_server:
        imaps_server = options.imaps_server
    elif options.config and "imaps-server" in iopts["spam"]:
        imaps_server = iopts["spam"]["imaps-server"]
    else:
        imaps_server = None
    if options.imaps_user:
        imaps_user = options.imaps_user
    elif options.config and "imaps-user" in iopts["spam"]:
        imaps_user = iopts["spam"]["imaps-user"]
    else:
        imaps_user = None
    if options.config and "imaps-pass" in iopts["spam"]:
        imaps_pass = iopts["spam"]["imaps-pass"]
    else:
        imaps_pass = None
    if options.wiki_template:
        template = options.wiki_template
    elif options.config and "wiki-template" in iopts["spam"]:
        template = iopts["spam"]["wiki-template"]
    else:
        template = "SpamTemplate"
    if options.url:
        url = options.url
        collab = CLIWiki(url)
    elif options.config and "url" in iopts["creds"]:
        url = iopts["creds"]["url"]
        collab = CLIWiki(url, config=options.config)
    else:
        parser.error("Collab URL needs to be specified. Use -h for help.")
    if imaps_server is not None and imaps_user is not None:
        if options.verbose:
            print "Reading new spam messages from:", imaps_server, imaps_user, "INBOX"
        metas = read_spam(collab, imaps_server, imaps_user, imaps_pass)
    else:
        parser.error("You need to specify IMAPS-SERVER and IMAPS-USER.")
    importMetas(collab, metas, template)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "Script interrupted via CTRL-C."
