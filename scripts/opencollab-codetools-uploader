#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
    @copyright: 2008 Lari Huttunen
    @license: MIT <http://www.opensource.org/licenses/mit-license.php>
"""
import os
import sys
import re
import glob
import optparse
import ConfigParser
from opencollab.wiki import CLIWiki
from opencollab.meta import Meta

def read_file(htaccess):
    content=""
    try:
        f = open(htaccess, 'r')
        content = f.read()
        f.close()
    except IOError:
        print "Couldn't read input file: ", sys.exc_info()[0]
    return content

def htaccess(htaccess,arena_user):
    content = read_file(htaccess)
    if(re.search(arena_user, content)):
        return True
    else:
        return False

def enum_dirs(arena_dir_glob,arena_user):
    flist=[]
    arena_dirs=[]
    flist = glob.glob(arena_dir_glob)
    for f in flist:
        dir,file = (os.path.split(f))
        if(htaccess(f, arena_user) == True):
            arena_dirs.append(dir)
    return arena_dirs

def uploadFile(collab,page_name,filename,path):
    abspath = path + "/" + filename
    file = open(abspath, "rb")
    parts_uploaded = False
    for current, total in collab.putAttachmentChunked(page_name, filename, file):
        percent = 100.0 * current / float(max(total, 1))
        status = current, total, percent
        sys.stdout.write("\rSent %d/%d bytes (%.02f%%) " % status)
        sys.stdout.write("of %s" % filename)
        sys.stdout.flush()
        parts_uploaded = True
    if(parts_uploaded == True):
        sys.stdout.write("\n")
    else:
        sys.stdout.write("Already uploaded %s\n" % filename)
    sys.stdout.flush()
    file.close()
    return parts_uploaded

def upload_files(collab, arena_dirs, marker):
    flist =[]
    jar = re.compile('\.jar')
    iso = re.compile('iso\.bz2')
    tar_gz = re.compile('tar\.gz')
    zip = re.compile('\.zip')
    pdf = re.compile('\.pdf')
    install = re.compile('\.install')
    ini = re.compile('\.ini')
    bnf = re.compile('\.bnf')
    html = re.compile('\.html?')
    txt = re.compile('\.txt')
    page_metas = Meta()
    for dir in arena_dirs:
        flist = os.listdir(dir)
        tmp = dir.rsplit('/', 2) 
        page_name = "/".join(tmp[1:3])
        changes = False
        #page_template = tmp[2].capitalize() + "ToolTemplate"
        page_template = "CodenomiconArenaTemplate"
        page_metas["category"].add("CategoryCodenomiconArena")
        if('release.txt' in flist):
            fname = dir + "/release.txt"
            #content = read_file(fname)
            page_metas["Release Notes"].add('{{attachment:release.txt}}')
            changes |= uploadFile(collab,page_name,"release.txt",dir)
        else:
            txt_files = filter(txt.search, flist)
            for txt_file in txt_files:
                page_metas["Text Document"].add('[[attachment:%s]]' % txt_file)
                changes |= uploadFile(collab,page_name,txt_file,dir)
        jar_files = filter(jar.search, flist) 
        for jar_file in jar_files:
            page_metas["JAR File"].add('[[attachment:%s]]' % jar_file)
            changes |= uploadFile(collab,page_name,jar_file,dir)
        iso_files = filter(iso.search, flist) 
        for iso_file in iso_files:
            page_metas["ISO File"].add('[[attachment:%s]]' % iso_file)
            changes |= uploadFile(collab,page_name,iso_file,dir)
        tar_gz_files = filter(tar_gz.search, flist) 
        for tar_gz_file in tar_gz_files:
            page_metas["TAR Archive"].add('[[attachment:%s]]' % tar_gz_file)
            changes |= uploadFile(collab,page_name,tar_gz_file,dir)
        zip_files = filter(zip.search, flist) 
        for zip_file in zip_files:
            page_metas["ZIP Archive"].add('[[attachment:%s]]' % zip_file)
            changes |= uploadFile(collab,page_name,zip_file,dir)
        pdf_files = filter(pdf.search, flist) 
        for pdf_file in pdf_files:
            page_metas["PDF Document"].add('[[attachment:%s]]' % pdf_file)
            changes |= uploadFile(collab,page_name,pdf_file,dir)
        install_files = filter(install.search, flist) 
        for install_file in install_files:
            page_metas["D3 Install File"].add('[[attachment:%s]]' % install_file)
            changes |= uploadFile(collab,page_name,install_file,dir)
        ini_files = filter(ini.search, flist) 
        for ini_file in ini_files:
            page_metas["INI File"].add('[[attachment:%s]]' % ini_file)
            changes |= uploadFile(collab,page_name,ini_file,dir)
        bnf_files = filter(bnf.search, flist) 
        for bnf_file in bnf_files:
            page_metas["Hotfix File"].add('[[attachment:%s]]' % bnf_file)
            changes |= uploadFile(collab,page_name,bnf_file,dir)
        html_files = filter(html.search, flist) 
        for html_file in html_files:
            page_metas["HTML Document"].add('[[attachment:%s]]' % html_file)
            changes |= uploadFile(collab,page_name,html_file,dir)

        if changes == True:
            print "NOTE: " + page_name + " attachments were updated"
            if marker:
                page_metas[marker].add('')
            
        collab.setMeta(page_name, page_metas, template=page_template, replace=True)
        page_metas = Meta()

def parse_config(cpath, args):
    configparser = ConfigParser.ConfigParser()
    configparser.readfp( open(cpath) )
    uris = dict( configparser.items("codetools") )
    if(uris.has_key("marker")):
        marker = uris["marker"]
    else:
        marker = None
    if len(args) == 0:
        arena_user = uris.pop("arena_user")
        arena_dir_glob = uris.pop("arena_dir_glob")
        return arena_dir_glob, arena_user, marker
    else:
        arena_dir_glob = uris.pop("arena_dir_glob")
        return arena_dir_glob, marker

def main():
    parser = optparse.OptionParser()
    parser.add_option( "-c", "--config",
        action="store",
        type="string", dest="cpath",
        help="Config file path.")
    parser.add_option( "-m", "--marker",
                       action="store",
                       default=None,
                       type="string", dest="marker",
                       help="Marker meta key to remove if tool has changed.")
    parser.add_option("-v",
        action="store_true", dest="verbose", default=False,
        help="Enable verbose output." )
    parser.set_usage("%prog [options] WIKIURL ARENA-DIR-GLOB TOOL-USER ")

    options, args = parser.parse_args()
    if options.cpath:
        if len(args) == 0:
            arena_dir_glob, arena_user, marker = \
                            parse_config(options.cpath, args)
        elif len(args) == 1:
            arena_dir_glob, marker = parse_config(options.cpath, args)
            arena_user = args.pop()
        elif len(args) == 2:
            arena_dir_glob, arena_user = args
        elif len(args) == 3:
            url, arena_dir_glob, arena_user = args
            collab = CLIWiki(url, config=options.cpath)
        if len(args) < 3:
            collab = CLIWiki(config=options.cpath)
    elif len(args) != 3:
        parser.error("Collab url, arena directory glob and tool username have to be defined.")
    else:
        url, arena_dir_glob, path = args
        collab = CLIWiki(url)

    if options.marker:
        marker = options.marker

    if marker:
        print "Removing meta key <" + marker + \
              "> for pages with changes in attachments"
    
    arena_dirs=[]
    arena_dirs = enum_dirs(arena_dir_glob, arena_user)
    upload_files(collab, arena_dirs, marker)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print "Script interrupted via CTRL-C."

